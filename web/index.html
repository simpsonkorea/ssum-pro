<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>ì½ì”¹ë‹¹í–ˆë‚˜</title>
  <script type="module">
    import { appLogin, IAP, Storage, closeView, share, generateHapticFeedback, getPlatformOS, getTossShareLink } from 'https://esm.sh/@apps-in-toss/web-framework@1.8.0';
    window.TossBridge = { appLogin, IAP, Storage, closeView, share, generateHapticFeedback, getPlatformOS, getTossShareLink };
  </script>
  <style>
    :root {
      --tds-primary: #3182f6;
      --tds-primary-dark: #1b64da;
      --tds-danger: #f04452;
      --tds-success: #00c73c;
      --tds-gray-900: #212529;
      --tds-gray-700: #495057;
      --tds-gray-600: #6b7684;
      --tds-gray-500: #8b95a1;
      --tds-gray-400: #b0b8c1;
      --tds-gray-300: #d1d6db;
      --tds-gray-100: #f2f4f6;
      --tds-gray-50: #f7f8f9;
      --tds-white: #ffffff;
      --brand-pink: #ec4899;
      --brand-pink-light: #fdf2f8;
      --brand-purple: #a855f7;
      --tds-f11: 11px; --tds-f13: 13px; --tds-f14: 14px; --tds-f15: 15px;
      --tds-f16: 16px; --tds-f17: 17px; --tds-f20: 20px; --tds-f22: 22px; --tds-f24: 24px;
      --tds-space-4: 4px; --tds-space-8: 8px; --tds-space-12: 12px;
      --tds-space-16: 16px; --tds-space-20: 20px; --tds-space-24: 24px; --tds-space-32: 32px;
      --tds-radius-8: 8px; --tds-radius-12: 12px; --tds-radius-16: 16px; --tds-radius-full: 9999px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html { height: 100%; }
    body {
      min-height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', sans-serif;
      background: var(--tds-white); color: var(--tds-gray-900); font-size: var(--tds-f16);
      line-height: 1.5; padding-bottom: env(safe-area-inset-bottom); -webkit-font-smoothing: antialiased;
    }
    .t2 { font-size: var(--tds-f24); font-weight: 700; line-height: 1.4; }
    .t3 { font-size: var(--tds-f22); font-weight: 700; line-height: 1.4; }
    .t4 { font-size: var(--tds-f20); font-weight: 600; line-height: 1.4; }
    .t5 { font-size: var(--tds-f17); font-weight: 600; line-height: 1.5; }
    .t6 { font-size: var(--tds-f15); font-weight: 500; line-height: 1.5; }
    .t7 { font-size: var(--tds-f13); font-weight: 400; line-height: 1.5; color: var(--tds-gray-600); }
    .btn {
      display: flex; align-items: center; justify-content: center;
      font-weight: 600; border: none; cursor: pointer; transition: all 0.2s ease;
    }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-xlarge { height: 56px; padding: 0 var(--tds-space-24); border-radius: var(--tds-radius-16); font-size: var(--tds-f17); }
    .btn-medium { height: 44px; padding: 0 var(--tds-space-16); border-radius: var(--tds-radius-8); font-size: var(--tds-f15); }
    .btn-primary { background: var(--tds-primary); color: var(--tds-white); }
    .btn-brand { background: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-purple) 100%); color: var(--tds-white); }
    .btn-light { background: var(--tds-gray-100); color: var(--tds-gray-900); }
    .btn-full { width: 100%; }
    .btn-pill { border-radius: var(--tds-radius-full); }
    .card { background: var(--tds-white); border-radius: var(--tds-radius-16); padding: var(--tds-space-20); box-shadow: 0 2px 8px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06); }
    .list-row { display: flex; align-items: center; gap: var(--tds-space-12); padding: var(--tds-space-16) 0; border-bottom: 1px solid var(--tds-gray-100); }
    .list-row:last-child { border-bottom: none; }
    .list-row-icon { font-size: 24px; flex-shrink: 0; }
    .list-row-content { flex: 1; }
    .list-row-title { font-size: var(--tds-f15); font-weight: 500; color: var(--tds-gray-900); }
    .list-row-desc { font-size: var(--tds-f13); color: var(--tds-gray-600); margin-top: 2px; }
    .badge { display: inline-flex; align-items: center; justify-content: center; height: 24px; padding: 0 var(--tds-space-8); border-radius: var(--tds-radius-full); font-size: var(--tds-f11); font-weight: 600; }
    .badge-success { background: #e8f5e9; color: #1b5e20; }
    .safe-top { padding-top: max(env(safe-area-inset-top), 20px); }
    .container { max-width: 480px; margin: 0 auto; padding: 0 var(--tds-space-20); }
    .page { min-height: 100vh; display: flex; flex-direction: column; }
    .page-center { justify-content: center; align-items: center; }
    .nav-header { position: sticky; top: 0; z-index: 100; background: rgba(255,255,255,0.9); backdrop-filter: blur(12px); border-bottom: 1px solid var(--tds-gray-100); padding: var(--tds-space-12) var(--tds-space-20); }
    .nav-header-inner { max-width: 480px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .nav-title { font-size: var(--tds-f17); font-weight: 700; color: var(--brand-pink); }
    .nav-user { font-size: var(--tds-f13); color: var(--tds-gray-600); }
    .animate-bounce { animation: bounce 1.5s ease-in-out infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(-8%); } 50% { transform: translateY(0); } }
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .gradient-bg { background: linear-gradient(180deg, var(--brand-pink-light) 0%, var(--tds-white) 50%); }
    .text-pink { color: var(--brand-pink); }
    .text-center { text-align: center; }
    .mb-8 { margin-bottom: var(--tds-space-8); }
    .mb-16 { margin-bottom: var(--tds-space-16); }
    .mb-24 { margin-bottom: var(--tds-space-24); }
    .mt-16 { margin-top: var(--tds-space-16); }
    .mt-20 { margin-top: var(--tds-space-20); }
    .review-card { background: var(--tds-white); border-radius: var(--tds-radius-12); padding: var(--tds-space-16); box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--tds-space-8); }
    .stat-item { text-align: center; padding: var(--tds-space-12); background: var(--tds-gray-50); border-radius: var(--tds-radius-8); }
    .stat-value { font-size: var(--tds-f20); font-weight: 700; color: var(--brand-pink); }
    .stat-label { font-size: var(--tds-f11); color: var(--tds-gray-600); margin-top: 2px; }
    .upload-zone { border: 2px dashed var(--tds-gray-300); border-radius: var(--tds-radius-12); padding: var(--tds-space-32); text-align: center; cursor: pointer; transition: all 0.2s; position: relative; }
    .upload-zone.done { border-color: var(--tds-success); background: #e8f5e9; }
    .upload-input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .chip { display: inline-flex; align-items: center; justify-content: center; height: 36px; padding: 0 var(--tds-space-16); border-radius: var(--tds-radius-full); font-size: var(--tds-f14); font-weight: 500; background: var(--tds-gray-100); color: var(--tds-gray-700); transition: all 0.2s; border: none; cursor: pointer; }
    .chip.active { background: var(--brand-pink); color: var(--tds-white); }
    .info-box { background: #fffbeb; border-radius: var(--tds-radius-12); padding: var(--tds-space-16); }
    .info-box-title { font-size: var(--tds-f14); font-weight: 600; color: #b45309; margin-bottom: var(--tds-space-8); }
    .info-box-list { font-size: var(--tds-f13); color: #92400e; }
    .info-box-list li { margin-bottom: var(--tds-space-4); }
    .price-original { font-size: var(--tds-f13); color: var(--tds-gray-500); text-decoration: line-through; }
    .price-current { font-size: var(--tds-f24); font-weight: 700; color: var(--brand-pink); }
    .discount-badge { background: var(--brand-pink-light); color: var(--brand-pink); font-size: var(--tds-f13); font-weight: 600; padding: var(--tds-space-8) var(--tds-space-12); border-radius: var(--tds-radius-8); text-align: center; }
    .loading-ring { width: 80px; height: 80px; border: 4px solid var(--brand-pink-light); border-top-color: var(--brand-pink); border-radius: 50%; }
  </style>
</head>
<body>
  <div id="app"></div>
  <script type="module">
    const API_BASE = 'https://ssum-pro.vercel.app';

    // State - phone ë‹¨ê³„ ì œê±°ë¨
    let state = {
      step: 'hook', // hook, value, social, login, payment, upload, analyze
      user: null,   // { id, name, phone } - Tossì—ì„œ ìë™ ì œê³µ
      isPaid: false,
      parsedData: null,
      selectedName: ''
    };

    // Toss Login - ì´ë¦„/ì „í™”ë²ˆí˜¸ ìë™ íšë“
    async function tossLogin() {
      try {
        const { authorizationCode, referrer } = await window.TossBridge.appLogin();
        // ì„œë²„ì—ì„œ í† í° êµí™˜ ë° ì‚¬ìš©ì ì •ë³´ íšë“
        const res = await fetch(`${API_BASE}/api/auth/toss/callback`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ authorizationCode, referrer })
        });
        if (res.ok) {
          const data = await res.json();
          // userì— phoneì´ í¬í•¨ë¨ (Tossì—ì„œ ìë™ ì œê³µ)
          return data.user;
        }
        throw new Error('Login failed');
      } catch (e) {
        console.error('Toss login error:', e);
        // í…ŒìŠ¤íŠ¸ìš© í´ë°±
        return { id: 'toss_' + Date.now(), name: 'í† ìŠ¤ ì‚¬ìš©ì', phone: null };
      }
    }

    // Toss IAP ê²°ì œ
    async function tossPurchase() {
      try {
        const { products } = await window.TossBridge.IAP.getProductItemList();
        const product = products.find(p => p.sku === 'ssum_analysis_report');
        if (!product) return true; // ë°ëª¨ ëª¨ë“œ

        return new Promise((resolve) => {
          const cleanup = window.TossBridge.IAP.createOneTimePurchaseOrder({
            options: {
              sku: product.sku,
              processProductGrant: async ({ orderId }) => {
                const res = await fetch(`${API_BASE}/api/payment/toss-iap`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ orderId, userKey: state.user?.id })
                });
                return res.ok;
              }
            },
            onEvent: (e) => { if (e.type === 'success') { cleanup(); resolve(true); } },
            onError: (e) => { cleanup(); resolve(e.code === 'INVALID_PRODUCT_ID'); }
          });
        });
      } catch (e) { return true; }
    }

    async function haptic(type = 'light') {
      try { await window.TossBridge.generateHapticFeedback({ type }); } catch (e) {}
    }

    // ê³µìœ  ë§í¬ ìƒì„±
    async function shareResult(reportId) {
      try {
        const deepLink = `intoss://chat-decoder/report/${reportId}`;
        const tossLink = await window.TossBridge.getTossShareLink(deepLink);
        await window.TossBridge.share({ message: `ë‚´ ì¸ ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•´ë´! ${tossLink}` });
      } catch (e) {
        console.error('Share error:', e);
      }
    }

    function parseCSV(text) {
      const lines = text.split('\n').filter(l => l.trim());
      const participants = new Set();
      const messages = [];
      const startIdx = lines[0]?.includes('Date,User,Message') ? 1 : 0;
      for (let i = startIdx; i < lines.length; i++) {
        const line = lines[i];
        const match = line.match(/^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}),"([^"]+)","(.+)"$/);
        if (match) {
          participants.add(match[2]);
          messages.push(`[${match[1]}] ${match[2]}: ${match[3]}`);
        } else {
          const parts = line.split(',');
          if (parts.length >= 3) {
            const user = parts[1]?.replace(/"/g, '').trim();
            const msg = parts.slice(2).join(',').replace(/"/g, '').trim();
            if (user && msg) { participants.add(user); messages.push(`${user}: ${msg}`); }
          }
        }
      }
      return { participants: Array.from(participants), messageCount: messages.length, rawText: messages.join('\n') };
    }

    async function analyze() {
      if (!state.parsedData || !state.selectedName) return;
      state.step = 'analyze';
      render();

      try {
        const res = await fetch(`${API_BASE}/api/analyze`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            conversation: state.parsedData.rawText,
            myName: state.selectedName,
            userId: state.user?.id,
            userPhone: state.user?.phone, // Tossì—ì„œ íšë“í•œ ì „í™”ë²ˆí˜¸
            platform: 'toss' // í† ìŠ¤ í”Œë«í¼ í‘œì‹œ â†’ ì„œë²„ì—ì„œ Toss Pushë¡œ ì•Œë¦¼
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'ë¶„ì„ì— ì‹¤íŒ¨í–ˆì–´ìš”');

        await window.TossBridge.Storage.setItem(`report_${data.reportId}`, JSON.stringify(data));

        // ë¶„ì„ ì™„ë£Œ í›„ ë¦¬í¬íŠ¸ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = `${API_BASE}/report/${data.reportId}?from=toss`;
      } catch (e) {
        alert(e.message || 'ë¶„ì„ ì¤‘ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”');
        state.step = 'upload';
        render();
      }
    }

    function render() {
      const app = document.getElementById('app');

      // Hook
      if (state.step === 'hook') {
        app.innerHTML = `
          <div class="page page-center gradient-bg">
            <div class="container text-center">
              <div class="animate-bounce" style="font-size:64px;margin-bottom:24px">ğŸ’”</div>
              <h1 class="t2" style="margin-bottom:12px">"ì´ ì‚¬ëŒ... ë‚˜ ì¢‹ì•„í•˜ëŠ” ê±¸ê¹Œ?"</h1>
              <p class="t6" style="color:var(--tds-gray-600);margin-bottom:32px">
                ë§¤ì¼ ì¹´í†¡í•˜ë©´ì„œë„ í™•ì‹ ì´ ì—†ì–´ì„œ<br>ë°¤ìƒˆ ëŒ€í™”ì°½ë§Œ ë“¤ì—¬ë‹¤ë³¸ ì  ìˆë‚˜ìš”?
              </p>
              <div style="margin-bottom:40px">
                <div class="list-row" style="border:none;justify-content:center">
                  <span class="list-row-icon">ğŸ˜°</span>
                  <span class="t6">"ì½ì”¹ë‹¹í–ˆëŠ”ë° ê´œì°®ì€ ê±´ê°€..."</span>
                </div>
                <div class="list-row" style="border:none;justify-content:center">
                  <span class="list-row-icon">ğŸ¤”</span>
                  <span class="t6">"ã…‹ã…‹ê°€ 3ê°œë©´ í˜¸ê°ì¸ê°€, 4ê°œë©´ í˜¸ê°ì¸ê°€"</span>
                </div>
                <div class="list-row" style="border:none;justify-content:center">
                  <span class="list-row-icon">ğŸ’­</span>
                  <span class="t6">"ë¨¼ì € ì—°ë½í•´ë„ ë ê¹Œ?"</span>
                </div>
              </div>
              <button onclick="nextStep('value')" class="btn btn-brand btn-xlarge btn-pill">5ì´ˆë§Œì— í™•ì¸í•˜ê¸°</button>
            </div>
          </div>`;
        return;
      }

      // Value
      if (state.step === 'value') {
        const items = [
          { icon: 'ğŸ’¯', title: 'í˜¸ê°ë„ ì ìˆ˜', desc: '0-100ì  ì •ë°€ ì¸¡ì •' },
          { icon: 'ğŸ’—', title: 'í˜¸ê° ì‹ í˜¸ ë¶„ì„', desc: 'ìƒëŒ€ê°€ ë³´ë‚¸ ê¸ì • ì‹œê·¸ë„' },
          { icon: 'âš ï¸', title: 'ê²½ê³  ì‹ í˜¸ ë¶„ì„', desc: 'ë†“ì¹˜ë©´ ì•ˆ ë˜ëŠ” ìœ„í—˜ ì‹ í˜¸' },
          { icon: 'ğŸ‘¤', title: 'ìƒëŒ€ë°© í”„ë¡œí•„ë§', desc: 'ì—°ì•  ìŠ¤íƒ€ì¼, ì„±í–¥ ë¶„ì„' },
          { icon: 'ğŸ’¬', title: 'ì¶”ì²œ ë©”ì‹œì§€ 3ê°œ', desc: 'ë°”ë¡œ ë³µì‚¬í•´ì„œ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”' },
          { icon: 'ğŸ—ºï¸', title: '3ì£¼ ê³µëµ ë¡œë“œë§µ', desc: 'ë‹¨ê³„ë³„ ì•¡ì…˜ í”Œëœ' },
          { icon: 'ğŸ¤–', title: 'AI ì—°ì•  ì½”ì¹˜', desc: '100íšŒ ë¬´ë£Œ ìƒë‹´' }
        ];
        app.innerHTML = `
          <div class="page gradient-bg">
            <div class="container" style="padding-top:48px;padding-bottom:32px">
              <div class="text-center mb-24">
                <div style="font-size:48px;margin-bottom:16px">ğŸ”®</div>
                <h2 class="t3">AIê°€ ëŒ€í™”ë¥¼ ì½ê³ <br><span class="text-pink">ìƒëŒ€ì˜ ì§„ì‹¬</span>ì„ ì•Œë ¤ì¤˜ìš”</h2>
              </div>
              <div class="card mb-16">
                <p class="t5 mb-16">ë¦¬í¬íŠ¸ì— í¬í•¨ëœ ë‚´ìš©</p>
                ${items.map(i => `
                  <div class="list-row">
                    <span class="list-row-icon">${i.icon}</span>
                    <div class="list-row-content">
                      <div class="list-row-title">${i.title}</div>
                      <div class="list-row-desc">${i.desc}</div>
                    </div>
                  </div>`).join('')}
              </div>
              <div class="card" style="background:var(--brand-pink-light);margin-bottom:24px">
                <div style="display:flex;align-items:center;gap:12px">
                  <span style="font-size:32px">ğŸ“š</span>
                  <div>
                    <p class="t6" style="font-weight:600">ì‹¬ë¦¬í•™ + ì½”ì¹­ ê¸°ë²• ê¸°ë°˜</p>
                    <p class="t7">CBT, í–‰ë™ì‹¬ë¦¬í•™, ì—°ì•  ì½”ì¹­ í”„ë ˆì„ì›Œí¬ ì ìš©</p>
                  </div>
                </div>
              </div>
              <button onclick="nextStep('social')" class="btn btn-brand btn-xlarge btn-full">ë‹¤ìŒ</button>
            </div>
          </div>`;
        return;
      }

      // Social
      if (state.step === 'social') {
        const reviews = [
          { name: 'ê¹€â—‹â—‹ (27, ì—¬)', text: 'ì§„ì§œ ì†Œë¦„... ì œê°€ ëŠë‚€ ê²ƒë“¤ì´ ë‹¤ ë§ì•˜ì–´ìš”. ê²°êµ­ ê³ ë°± ë°›ì•˜ì–´ìš” ğŸ’•', score: 78 },
          { name: 'ë°•â—‹â—‹ (31, ë‚¨)', text: 'ì½ì”¹ ë•Œë¬¸ì— ê³ ë¯¼í–ˆëŠ”ë°, ë¶„ì„ ë³´ë‹ˆê¹Œ ê±”ê°€ ì›ë˜ ë‹µì¥ ëŠë¦° ìŠ¤íƒ€ì¼ì´ì—ˆì–´ìš”!', score: 65 },
          { name: 'ì´â—‹â—‹ (24, ì—¬)', text: 'AI ì½”ì¹˜ê°€ ì•Œë ¤ì¤€ ë©”ì‹œì§€ ê·¸ëŒ€ë¡œ ë³´ëƒˆë”ë‹ˆ ë°”ë¡œ ë°ì´íŠ¸ ì‹ ì²­ ë°›ì•˜ì–´ìš” ã…‹ã…‹', score: 82 }
        ];
        app.innerHTML = `
          <div class="page gradient-bg">
            <div class="container" style="padding-top:48px;padding-bottom:32px">
              <div class="text-center mb-24">
                <h2 class="t3">ì´ë¯¸ <span class="text-pink">12,847ëª…</span>ì´<br>ì¸ì˜ í™•ì‹ ì„ ì–»ì—ˆì–´ìš”</h2>
              </div>
              <div style="margin-bottom:24px">
                ${reviews.map(r => `
                  <div class="review-card" style="margin-bottom:12px">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                      <span class="t6">${r.name}</span>
                      <span class="t5 text-pink">${r.score}ì </span>
                    </div>
                    <p class="t7">${r.text}</p>
                  </div>`).join('')}
              </div>
              <div class="stats-grid mb-24">
                <div class="stat-item"><div class="stat-value">94%</div><div class="stat-label">ë¶„ì„ ì •í™•ë„</div></div>
                <div class="stat-item"><div class="stat-value">87%</div><div class="stat-label">ì»¤í”Œ ì„±ê³µë¥ </div></div>
                <div class="stat-item"><div class="stat-value">4.9</div><div class="stat-label">ë§Œì¡±ë„ â­</div></div>
              </div>
              <button onclick="nextStep('login')" class="btn btn-brand btn-xlarge btn-full">ë‚˜ë„ ë¶„ì„ë°›ê¸°</button>
            </div>
          </div>`;
        return;
      }

      // Login (Toss) - ì „í™”ë²ˆí˜¸ ì…ë ¥ ë‹¨ê³„ ì œê±°ë¨, ë°”ë¡œ ê²°ì œë¡œ ì´ë™
      if (state.step === 'login') {
        app.innerHTML = `
          <div class="page page-center">
            <div class="container text-center">
              <div style="font-size:48px;margin-bottom:16px">ğŸ”</div>
              <h2 class="t3 mb-8">í† ìŠ¤ë¡œ ê°„í¸í•˜ê²Œ ì‹œì‘í•´ìš”</h2>
              <p class="t7 mb-24">ë¡œê·¸ì¸í•˜ë©´ ë¶„ì„ ì™„ë£Œ ì‹œ í† ìŠ¤ ì•Œë¦¼ìœ¼ë¡œ ì•Œë ¤ë“œë ¤ìš”</p>
              <button onclick="handleTossLogin()" class="btn btn-primary btn-xlarge btn-full" style="margin-bottom:16px">
                í† ìŠ¤ë¡œ ì‹œì‘í•˜ê¸°
              </button>
              <p class="t7">ë¡œê·¸ì¸í•˜ë©´ ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ì— ë™ì˜í•˜ê²Œ ë¼ìš”</p>
            </div>
          </div>`;
        return;
      }

      // Payment
      if (state.step === 'payment') {
        app.innerHTML = `
          <div class="page">
            <header class="nav-header safe-top">
              <div class="nav-header-inner">
                <span class="nav-title">ì½ì”¹ë‹¹í–ˆë‚˜</span>
                <span class="nav-user">${state.user?.name || 'ì‚¬ìš©ì'}ë‹˜</span>
              </div>
            </header>
            <div class="container" style="padding-top:24px;padding-bottom:32px">
              <div class="text-center mb-24">
                <h2 class="t3 mb-8">ë§ˆì§€ë§‰ ë‹¨ê³„ì˜ˆìš”!</h2>
                <p class="t7">ê²°ì œ í›„ ë°”ë¡œ ëŒ€í™”ë¥¼ ë¶„ì„í•´ ë“œë¦´ê²Œìš”</p>
              </div>
              <div class="card mb-16">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                  <span class="t5">AI ì¸ ë¶„ì„ ë¦¬í¬íŠ¸</span>
                  <div style="text-align:right">
                    <span class="price-original">49,900ì›</span>
                    <span class="price-current" style="margin-left:8px">29,900ì›</span>
                  </div>
                </div>
                <div style="margin-bottom:16px">
                  ${['ì •ë°€ í˜¸ê°ë„ ë¶„ì„ ë¦¬í¬íŠ¸','AI ì—°ì•  ì½”ì¹˜ 100íšŒ ìƒë‹´','3ì£¼ ê³µëµ ë¡œë“œë§µ','í‰ìƒ ë³´ê´€ ê°€ëŠ¥'].map(t => `
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                      <span style="color:var(--tds-success)">âœ“</span>
                      <span class="t7" style="color:var(--tds-gray-700)">${t}</span>
                    </div>`).join('')}
                </div>
                <div class="discount-badge mb-16">ğŸ‰ ì§€ê¸ˆ ê²°ì œí•˜ë©´ 40% í• ì¸ì´ ì ìš©ë¼ìš”</div>
                <button onclick="handlePurchase()" class="btn btn-primary btn-xlarge btn-full" style="margin-bottom:12px">29,900ì› ê²°ì œí•˜ê¸°</button>
                <button onclick="handleDemoPurchase()" class="btn btn-light btn-medium btn-full">[í…ŒìŠ¤íŠ¸] ê²°ì œ ê±´ë„ˆë›°ê¸°</button>
              </div>
              <div style="display:flex;justify-content:center;gap:16px" class="t7">
                <span>ğŸ”’ ì•ˆì „í•œ ê²°ì œ</span>
                <span>ğŸ“± í† ìŠ¤ ì¸ì•±ê²°ì œ</span>
              </div>
            </div>
          </div>`;
        return;
      }

      // Upload
      if (state.step === 'upload') {
        app.innerHTML = `
          <div class="page">
            <header class="nav-header safe-top">
              <div class="nav-header-inner">
                <span class="nav-title">ì½ì”¹ë‹¹í–ˆë‚˜</span>
                <span class="nav-user">${state.user?.name || 'ì‚¬ìš©ì'}ë‹˜</span>
              </div>
            </header>
            <div class="container" style="padding-top:24px;padding-bottom:32px">
              <div class="text-center mb-24">
                <span class="badge badge-success mb-8">âœ“ ê²°ì œ ì™„ë£Œ</span>
                <h2 class="t3 mb-8">ì´ì œ ëŒ€í™”ë¥¼ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”</h2>
                <p class="t7">ë¶„ì„ì´ ëë‚˜ë©´ í† ìŠ¤ ì•Œë¦¼ìœ¼ë¡œ ì•Œë ¤ë“œë¦´ê²Œìš”</p>
              </div>
              <div class="info-box mb-16">
                <div class="info-box-title">ğŸ“± ëŒ€í™” ë‚´ë³´ë‚´ê¸° ë°©ë²•</div>
                <ol class="info-box-list" style="padding-left:16px">
                  <li>ì¹´ì¹´ì˜¤í†¡ì—ì„œ ë¶„ì„í•  ëŒ€í™”ë°© ì—´ê¸°</li>
                  <li>ìš°ì¸¡ ìƒë‹¨ â‰¡ ë²„íŠ¼ íƒ­í•˜ê¸°</li>
                  <li>ëŒ€í™” ë‚´ìš© ë‚´ë³´ë‚´ê¸° ì„ íƒ</li>
                  <li>CSV íŒŒì¼ë¡œ ì €ì¥</li>
                  <li>ì—¬ê¸°ì— ì—…ë¡œë“œ!</li>
                </ol>
              </div>
              <div class="card mb-16">
                <div class="upload-zone ${state.parsedData?'done':''}">
                  <input type="file" accept=".csv,.txt" class="upload-input" id="fileInput">
                  ${state.parsedData ? `
                    <div style="color:var(--tds-success)">
                      <div style="font-size:40px;margin-bottom:8px">âœ“</div>
                      <p class="t5">íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ!</p>
                      <p class="t7">${state.parsedData.messageCount}ê°œ ë©”ì‹œì§€ Â· ${state.parsedData.participants.length}ëª… ì°¸ì—¬</p>
                    </div>
                  ` : `
                    <div style="color:var(--tds-gray-500)">
                      <div style="font-size:40px;margin-bottom:8px">ğŸ“</div>
                      <p class="t6">CSV íŒŒì¼ì„ íƒ­í•´ì„œ ì„ íƒí•´ ì£¼ì„¸ìš”</p>
                    </div>
                  `}
                </div>
                ${state.parsedData?.participants.length ? `
                  <div class="mt-20">
                    <p class="t6 mb-8">ğŸ™‹ ë‚˜ëŠ” ëˆ„êµ¬ì¸ê°€ìš”?</p>
                    <div style="display:flex;flex-wrap:wrap;gap:8px">
                      ${state.parsedData.participants.map(n => `
                        <button onclick="selectName('${n}')" class="chip ${state.selectedName===n?'active':''}">${n}</button>
                      `).join('')}
                    </div>
                  </div>
                  ${state.selectedName ? `
                    <button onclick="analyze()" class="btn btn-brand btn-xlarge btn-full mt-20">ë¶„ì„ ì‹œì‘í•˜ê¸° ğŸ”®</button>
                  ` : ''}
                ` : ''}
              </div>
              <p class="t7 text-center">ğŸ”’ ëŒ€í™” ë‚´ìš©ì€ ë¶„ì„ í›„ ì¦‰ì‹œ ì‚­ì œë¼ìš”</p>
            </div>
          </div>`;
        document.getElementById('fileInput')?.addEventListener('change', (e) => {
          const file = e.target.files?.[0];
          if (file) handleFile(file);
        });
        return;
      }

      // Analyze
      if (state.step === 'analyze') {
        app.innerHTML = `
          <div class="page page-center">
            <div class="container text-center">
              <div style="position:relative;width:80px;height:80px;margin:0 auto 24px">
                <div class="loading-ring animate-spin"></div>
                <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:32px">ğŸ”®</div>
              </div>
              <h2 class="t4 mb-8">AIê°€ ëŒ€í™”ë¥¼ ë¶„ì„í•˜ê³  ìˆì–´ìš”</h2>
              <p class="t7 mb-24">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</p>
              <div style="text-align:left;max-width:200px;margin:0 auto">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px" class="t7">
                  <span style="color:var(--tds-success)">âœ“</span> ë©”ì‹œì§€ íŒ¨í„´ ë¶„ì„ ì¤‘
                </div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px" class="t7">
                  <span class="animate-pulse">â³</span> í˜¸ê° ì‹ í˜¸ íƒì§€ ì¤‘
                </div>
                <div style="display:flex;align-items:center;gap:8px;color:var(--tds-gray-400)" class="t7">
                  <span>â—‹</span> ë¦¬í¬íŠ¸ ìƒì„± ì¤‘
                </div>
              </div>
            </div>
          </div>`;
        return;
      }
    }

    // Globals
    window.nextStep = async (step) => { await haptic(); state.step = step; render(); };

    // ë¡œê·¸ì¸ â†’ ë°”ë¡œ ê²°ì œ ë‹¨ê³„ë¡œ (phone ë‹¨ê³„ ì œê±°)
    window.handleTossLogin = async () => {
      await haptic();
      state.user = await tossLogin();
      if (state.user) {
        state.step = 'payment'; // phone ìŠ¤í‚µ, ë°”ë¡œ paymentë¡œ
        render();
      }
    };

    window.handlePurchase = async () => {
      await haptic('medium');
      if (await tossPurchase()) {
        state.isPaid = true;
        state.step = 'upload';
        render();
      }
    };

    window.handleDemoPurchase = () => { haptic(); state.isPaid = true; state.step = 'upload'; render(); };
    window.selectName = (n) => { haptic(); state.selectedName = n; render(); };
    window.analyze = analyze;
    window.shareResult = shareResult;

    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        state.parsedData = parseCSV(e.target?.result);
        if (state.parsedData.participants.length) state.selectedName = state.parsedData.participants[0];
        haptic();
        render();
      };
      reader.readAsText(file, 'UTF-8');
    }

    render();
  </script>
</body>
</html>
